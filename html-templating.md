# peercast HTML テンプレートシステム

## 概要

peercast の HTML テンプレートでは、ディレクティブを以下の形式で埋め込
むことができる。

    {$変数名}
    {@キーワード...}

変数名は `servMgr.upgradeURL` のようなドットで区切られた単語。この場合
プログラム内のグローバル変数である `servMgr` の `writeVariable` メソッ
ドが呼ばれて `upgradeURL` 変数の内容が文書に展開される。

変数名とその意味は、それぞれのオブジェクトが好きに決められる。第一単語
とプログラム内のオブジェクトのマッピングはハードコードされている。

キーワードには、`if`, `else`, `end`, `loop` がある。

## 変数名

`servMgr`, `chanMgr`, `stats` はそれぞれプログラム内のグローバル変数に
対応している。

特殊な変数として `loop` があり、`loop` ブロック内で i 番目の要素にアク
セスするために使われる。

また `page` 変数はページのクエリー文字列で `id=...` で表わされる ID の
チャンネルを、`page.channel` でアクセスするために使われる。

## if ディレクティブ

`{@if 条件変数} A {@end}` あるいは、`{@if 条件変数} A {@else} B
{@end}` の形で使われ、条件変数の値が真ならば A の部分が有効になり、偽
ならば B の部分が有効になる。

条件変数の値である文字列は、先頭が数字であればいったん整数に変換され、
0 の場合だけが偽として扱われる。それ以外の文字列は空文字列だけが偽とし
て扱われる。

## loop ディレクティブ

`loop servMgr.numServents` のようにループする回数を変数名で指定する。

ブロック内では `loop.` で始まる変数が使えるようになる。

### loop.index

ループのインデックス。0 から始まる。

### loop.indexEven

ループのインデックスが偶数であるかどうか。

### コレクションへのアクセス

`loop.servent`, `loop.channel`, `loop.hit`, `loop.bcid`, `loop.filter`
で、それぞれ `loop.index` で表わされる位置のサーバント、チャンネル、ヒッ
ト[^1]、ブロードキャストID、フィルターにアクセスできる。

`loop.hit` の場合、どのチャンネルのヒットかは、クエリー文字列の
`id=...` で指定される。

[^1]: チャンネルをリレーしているノードの情報のこと。
